# Backward Pass Debugging Guide

This guide explains the changes made to the codebase and how to use the debugging tools to identify and fix issues with the backward pass functionality.

## Overview of Changes

We've made the following enhancements to the codebase:

1. **Added Extensive Logging**:
   - Added detailed logging to the `PromptOptimizer` class
   - Added detailed logging to the `Archer.run_backward_pass` method
   - Added logging to the Gradio app's `trigger_backward_pass` method

2. **Display Current Prompts in UI**:
   - Modified the Gradio interface to show the current prompts in the radio display
   - Added a "Show Current Prompts" button to update the display

3. **Created Debugging Scripts**:
   - `test_backward_pass_flow.py`: Integration tests for the backward pass
   - `test_radio_flow.py`: Simulates the complete radio flow with logging
   - `debug_backward_pass.py`: Directly tests each step of the backward pass

## Running the Debugging Scripts

### 1. Integration Tests

Run the integration tests to verify the backward pass functionality:

```bash
python tests/test_backward_pass_flow.py
```

This will run a series of tests to validate different aspects of the backward pass:
- Basic backward pass execution
- Empty evaluations handling
- Error handling
- AdaLFlow optimization
- Complete integration flow

### 2. Radio Flow Test

Simulate the complete radio flow with logging:

```bash
python test_radio_flow.py
```

Options:
- `--disable-adalflow`: Run without AdaLFlow
- `--skip-optimization`: Skip the backward pass step
- `--verbose`: Enable more detailed logging

### 3. Backward Pass Debug

Directly debug each step of the backward pass:

```bash
python debug_backward_pass.py
```

This script will:
1. Check AdaLFlow availability and status
2. Debug each step of the backward pass in isolation
3. Test the backward pass with the Danielson model

## Interpreting the Results

The logs generated by these scripts will help identify which part of the backward pass is failing:

### Common Issues to Look For

1. **AdaLFlow Import Issues**:
   - Check if `ADALFLOW_AVAILABLE` is `True` or `False`
   - Look for import errors in the logs

2. **Parameter Wrapping Issues**:
   - Check if `_wrap_prompts_as_params` is returning parameters correctly
   - Verify that parameters have the correct data

3. **Backward Pass Failures**:
   - Look for errors in the `param.backward()` calls
   - These typically involve LLM API calls failing

4. **Optimizer Issues**:
   - Check if the optimizer's `propose()` and `step()` methods are being called
   - Look for errors in the optimizer logs

5. **Active Prompts Updates**:
   - Verify that `active_prompts` are being updated after optimization
   - Check that `generator.set_prompts()` is being called with new prompts

## Log File Locations

- `backward_pass_test.log`: Logs from integration tests
- `radio_flow.log`: Logs from the radio flow test
- `backward_pass_debug.log`: Detailed logs from the debugging script

## Running the Application with Debugging

To run the application with all the debugging enhancements:

```bash
python app.py --port 7860
```

Use the Gradio interface to:
1. Generate evaluations
2. Save feedback
3. Check the current prompts
4. Trigger the backward pass
5. View the optimized prompts

## Next Steps

After identifying the specific issue with the backward pass:

1. If it's an AdaLFlow import issue, ensure the library is installed correctly
2. If it's an API key issue, check the environment variables
3. If it's a parameter wrapping issue, review the `_wrap_prompts_as_params` method
4. If it's a backward method issue, check the LLM API calls
5. If prompts aren't being updated, verify the flow from optimization to updating the active prompts

## Maintenance Note

The extensive logging added to the codebase significantly improves debugging capabilities but might impact performance. Once the issues are resolved, consider adjusting the log levels for production use. 